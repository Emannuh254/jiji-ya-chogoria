<!DOCTYPE html>
<html>
<head>
    <title>Jiji ya Chogoria - Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7"></script>
    <link rel="stylesheet" href="index.css">
</head>
<body>
    <header>
        <div class="container">
            <nav class="navbar">
                <a href="dashboard.html" class="logo">Jiji ya Chogoria</a>
                <ul class="nav-links">
                    <li><a href="dashboard.html" class="dashboard active">Dashboard</a></li>
                    <li><a href="chat.html" class="chat">Chat</a></li>
                    <li><a href="post-product.html" class="post product">Post product üõí</a></li>
                    <li><a href="settings.html" class="settings">Settings</a></li>
                    <li><a href="#" class="logout" id="logout-btn">Logout</a></li>
                </ul>
                <a href="post-product.html" class="post-product-btn">Post Product</a>
                <button class="mobile-menu-toggle" id="mobile-menu-toggle">‚ò∞</button>
            </nav>
        </div>
    </header>
    
    <main class="container">
        <div id="user-info">
            <span id="user-name"></span>
        </div>
        
        <div id="products-container">
            <h2>Available Products</h2>
            <div id="products-list">
                <div class="loading-spinner">Loading products...</div>
            </div>
        </div>
    </main>

    <footer>
        <div class="container">
            <p>&copy; 2025 Jiji ya Chogoria by mannuh. All rights reserved.</p>
        </div>
    </footer>

    <script>
    // Initialize Supabase
    const supabaseUrl = 'https://lrezerxsbuekkhmpverr.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxyZXplcnhzYnVla2tobXB2ZXJyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgzNTI3MjMsImV4cCI6MjA3MzkyODcyM30.96senppPRMHveFi2ouDPDqhh17XIwxsLvA4U0rvjU9g';
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

    // Mobile menu toggle
    const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
    const navLinks = document.querySelector('.nav-links');

    mobileMenuToggle.addEventListener('click', () => {
        navLinks.classList.toggle('active');
    });

    // Close mobile menu when clicking on a link
    document.querySelectorAll('.nav-links a').forEach(link => {
        link.addEventListener('click', () => {
            navLinks.classList.remove('active');
        });
    });

    // Toast notification function
    function showToast(message, type = 'success') {
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        document.body.appendChild(toast);

        setTimeout(() => toast.remove(), 3000);
    }

    // Check authentication and ensure profile exists
    async function checkAuth() {
        const { data: { user }, error } = await supabase.auth.getUser();
        if (!user) {
            window.location.href = 'index.html';
            return null;
        }

        // Check if profile exists
        const { data: profile, error: profileError } = await supabase
            .from('profiles')
            .select('*')
            .eq('id', user.id)
            .single();

        if (profileError || !profile) {
            // Create profile if it doesn‚Äôt exist
            const { error: insertError } = await supabase
                .from('profiles')
                .insert([{
                    id: user.id,
                    full_name: user.user_metadata?.full_name || user.email
                }]);
            if (insertError) console.error('Error creating profile:', insertError);
        }

        document.getElementById('user-name').textContent =
            `Welcome, ${user.user_metadata?.full_name || user.email}`;
        return user;
    }

    // Load products
    async function loadProducts() {
        const productsList = document.getElementById('products-list');
        productsList.innerHTML = '<div class="loading-spinner">Loading products...</div>';

        try {
            const { data, error } = await supabase
                .from('products')
                .select(`
                    *,
                    profiles(full_name)
                `)
                .order('created_at', { ascending: false });

            if (error) {
                console.error('Error loading products:', error);
                productsList.innerHTML = `<div class="error-message">‚ö†Ô∏è ${error.message}</div>`;
                showToast('Error loading products', 'error');
                return;
            }

            productsList.innerHTML = '';

            if (!data || data.length === 0) {
                productsList.innerHTML = '<div class="no-products">No products available yet.</div>';
                return;
            }

            data.forEach(product => {
                const statusClass = product.status === 'in_stock'
                    ? 'in-stock'
                    : product.status === 'sold'
                        ? 'sold'
                        : 'reserved';

                const imageHtml = product.image_url
                    ? `<div class="product-image"><img src="${product.image_url}" alt="${product.name}" onerror="this.src=''; this.parentElement.classList.add('placeholder'); this.parentElement.innerHTML='üì∑ No Image';"></div>`
                    : `<div class="product-image placeholder">üì∑ No Image</div>`;

                const productEl = document.createElement('div');
                productEl.className = 'product-card';
                productEl.innerHTML = `
                    ${imageHtml}
                    <div class="product-details">
                        <h3>${product.name}</h3>
                        <p>${product.description || 'No description provided.'}</p>
                        <p><strong>Price:</strong> KES ${product.price || 'N/A'}</p>
                        <p><strong>Status:</strong> <span class="status-indicator ${statusClass}">
                            ${product.status?.replace('_', ' ').toUpperCase() || 'UNKNOWN'}
                        </span></p>
                        <p><strong>Seller:</strong> ${product.profiles?.full_name || 'Unknown'}</p>
                        <p><strong>Posted:</strong> ${new Date(product.created_at).toLocaleString()}</p>
                        <button class="chat-seller-btn"
                            data-seller-id="${product.user_id}"
                            data-seller-name="${product.profiles?.full_name || 'Seller'}"
                            data-product-title="${product.name}">
                            Chat with Seller
                        </button>
                    </div>
                `;

                productsList.appendChild(productEl);
            });

            // Add event listeners for chat buttons
            document.querySelectorAll('.chat-seller-btn').forEach(button => {
                button.addEventListener('click', function () {
                    const sellerId = this.dataset.sellerId;
                    const sellerName = this.dataset.sellerName;
                    const productTitle = this.dataset.productTitle;

                    sessionStorage.setItem('chatSellerId', sellerId);
                    sessionStorage.setItem('chatSellerName', sellerName);
                    sessionStorage.setItem('chatProductTitle', productTitle);

                    window.location.href = 'chat.html';
                });
            });
        } catch (err) {
            console.error('Unexpected error:', err);
            productsList.innerHTML = '<div class="error-message">Unexpected error while loading products.</div>';
            showToast('Unexpected error occurred', 'error');
        }
    }

    // Logout
    document.getElementById('logout-btn').addEventListener('click', async () => {
        await supabase.auth.signOut();
        showToast('üëã Logged out successfully');
        setTimeout(() => window.location.href = 'index.html', 1000);
    });

    // Initialize
    checkAuth().then(() => {
        loadProducts();

        // Real-time subscription for updates
        supabase
            .channel('products')
            .on('postgres_changes', { event: '*', schema: 'public', table: 'products' }, () => {
                loadProducts();
            })
            .subscribe();
    });
  </script>



</body>
</html>