<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Aviator — Mobile Enhanced</title>
  <style>
    /* Reset */
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%;background:linear-gradient(#7ec0ff 0%, #cfeaff 60%, #f7fbff 100%);font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;color:#04213b;overflow:hidden}

    /* Stage */
    .stage{position:relative;width:100%;height:100vh;overflow:hidden;display:flex;align-items:flex-end;justify-content:center;padding-bottom:6vh}

    /* Sky layers for parallax */
    .sky{position:absolute;inset:0;pointer-events:none}
    .sun{position:absolute;right:6%;top:6%;width:120px;height:120px;border-radius:50%;background:radial-gradient(circle at 30% 30%, #fff8e6, #ffd36b 40%, #ffb84d 100%);opacity:0.95;filter:blur(2px)}

    /* Clouds */
    .clouds{position:absolute;inset:0}
    .cloud{position:absolute;border-radius:50%;opacity:0.95;filter:blur(6px);background:linear-gradient(180deg,#ffffff,#eef7ff);box-shadow:0 10px 30px rgba(0,0,0,0.06)}

    /* Ground with more detail */
    .ground{position:absolute;left:0;right:0;bottom:0;height:18%;background:linear-gradient(180deg,#cfeef1,#b8e6ff);transform:skewY(-3deg);filter:brightness(0.96)}
    .ground::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 40%;
        background: repeating-linear-gradient(90deg, rgba(255,255,255,0.1) 0px, rgba(255,255,255,0.1) 2px, transparent 2px, transparent 8px);
    }

    /* Buildings for more realistic scene */
    .buildings {
        position: absolute;
        bottom: 18%;
        left: 0;
        right: 0;
        height: 25%;
        display: flex;
        justify-content: space-around;
        align-items: flex-end;
        z-index: 5;
    }
    .building {
        width: 8%;
        height: 60%;
        background: linear-gradient(180deg, #a0c4ff, #7ba7ff);
        border-radius: 4px 4px 0 0;
        position: relative;
        box-shadow: 0 0 20px rgba(0,0,0,0.1);
    }
    .building::after {
        content: '';
        position: absolute;
        top: 10%;
        left: 20%;
        right: 20%;
        height: 80%;
        background: repeating-linear-gradient(0deg, rgba(255,255,255,0.2) 0px, rgba(255,255,255,0.2) 3px, transparent 3px, transparent 10px);
    }

    /* Controls - mobile optimized */
    .controls {
        position: absolute;
        left: 14px;
        top: 14px;
        background: rgba(255,255,255,0.86);
        backdrop-filter: blur(6px);
        border-radius: 12px;
        padding: 10px 14px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        box-shadow: 0 8px 24px rgba(6,24,40,0.08);
        z-index: 60;
        max-width: 90%;
    }
    .controls-row {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
    }
    .controls button {
        border: 0;
        background: #0b76ff;
        color: white;
        padding: 12px 16px;
        border-radius: 10px;
        font-weight: 700;
        cursor: pointer;
        letter-spacing: 0.3px;
        font-size: 16px;
        flex: 1;
        min-width: 100px;
        touch-action: manipulation;
    }
    .controls button.ghost {
        background: transparent;
        color: #0b76ff;
        border: 1px solid rgba(11,118,255,0.12);
    }
    .mute {
        background: transparent;
        border-radius: 8px;
        padding: 10px 12px;
        border: 1px solid rgba(6,24,40,0.06);
        cursor: pointer;
        font-size: 18px;
        width: 48px;
        height: 48px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .meter {
        font-weight: 800;
        color: #05204a;
        padding-left: 8px;
        min-width: 120px;
        text-align: right;
        font-size: 18px;
    }

    /* Plane wrapper - zoomed out perspective */
    .plane-wrap {
        position: absolute;
        left: 50%;
        bottom: 22%;
        transform-origin: center center;
        will-change: transform;
        pointer-events: none;
        z-index: 40;
    }
    .plane {
        width: 340px;
        height: auto;
        transform-origin: 55% 60%;
        filter: drop-shadow(0 18px 36px rgba(2,18,40,0.18));
    }

    /* Enhanced streak for speed */
    .streak {
        position: absolute;
        left: 0;
        top: 46%;
        width: 420px;
        height: 10px;
        border-radius: 999px;
        opacity: 0.22;
        transform-origin: left;
        filter: blur(6px);
        background: linear-gradient(90deg, rgba(255,255,255,0), rgba(160,200,255,0.22), rgba(255,255,255,0));
    }
    .streak::before {
        content: '';
        position: absolute;
        top: -5px;
        left: 0;
        right: 0;
        height: 20px;
        background: radial-gradient(ellipse at center, rgba(255,255,255,0.8), transparent 70%);
        filter: blur(8px);
    }

    /* Enhanced smoke / contrail container */
    #contrails {
        position: absolute;
        left: 0;
        top: 0;
        pointer-events: none;
        z-index: 30;
    }

    /* Enhanced money fly-away container */
    .money-wrap {
        position: absolute;
        left: 50%;
        top: 12%;
        transform: translateX(-50%);
        pointer-events: none;
        z-index: 80;
    }
    .bill {
        position: absolute;
        width: 78px;
        height: 40px;
        border-radius: 6px;
        background: linear-gradient(180deg, #e6ffef, #d1ffd9);
        box-shadow: 0 6px 18px rgba(0,0,0,0.12);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 800;
        color: #0a5b2b;
        border: 2px solid rgba(10,91,43,0.08);
        font-size: 14px;
    }

    /* Enhanced crowd overlay */
    .crowd {
        position: absolute;
        left: 50%;
        bottom: 6vh;
        transform: translateX(-50%);
        display: flex;
        gap: 6px;
        z-index: 50;
    }
    .person {
        width: 8px;
        height: 18px;
        background: #123;
        opacity: 0.65;
        border-radius: 2px;
    }

    /* Enhanced flash effect */
    .flash {
        position: absolute;
        inset: 0;
        background: radial-gradient(circle at 50% 40%, rgba(255,255,255,0.28), rgba(255,255,255,0) 30%);
        opacity: 0;
        pointer-events: none;
        z-index: 90;
    }

    /* Mobile controls overlay */
    .mobile-controls {
        position: absolute;
        bottom: 20px;
        left: 0;
        right: 0;
        display: flex;
        justify-content: center;
        gap: 20px;
        z-index: 100;
        padding: 0 20px;
    }
    .mobile-btn {
        width: 70px;
        height: 70px;
        border-radius: 50%;
        background: rgba(255,255,255,0.9);
        border: none;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        color: #0b76ff;
        touch-action: manipulation;
    }
    .mobile-btn:active {
        transform: scale(0.95);
    }

    /* Responsive tweaks */
    @media (max-width:900px) {
        .plane { width: 260px }
        .streak { width: 300px }
        .controls { left: 8px; top: 8px; padding: 8px }
        .meter { min-width: 84px }
        .controls button { font-size: 14px; padding: 10px 12px }
    }
    @media (max-width:520px) {
        .plane { width: 190px }
        .plane-wrap { bottom: 16% }
        .controls { 
            top: auto; 
            bottom: 12px; 
            left: 50%; 
            transform: translateX(-50%);
            width: calc(100% - 32px);
            max-width: none;
        }
        .controls-row { flex-direction: column; }
        .controls button { width: 100%; min-width: auto }
        .meter { min-width: auto; text-align: center; padding-left: 0; margin-top: 8px }
        .crowd { display: none }
        .mobile-controls { display: flex }
    }

    /* Animations - money + confetti-like float */
    @keyframes floatUp {
      0%{transform:translateY(0) rotate(0deg);opacity:1}
      60%{opacity:1}
      100%{transform:translateY(-200px) rotate(360deg);opacity:0}
    }

    @keyframes swooshLeft {
      0%{transform:translateX(0) rotate(-2deg)}
      100%{transform:translateX(-220px) rotate(-28deg);opacity:0}
    }

    /* Enhanced plane animation */
    @keyframes planeTakeoff {
      0% { transform: translate(-50%, 0vh) scale(0.95) rotate(6deg); }
      50% { transform: translate(-50%, -8vh) scale(1.05) rotate(-12deg); }
      100% { transform: translate(-50%, -15vh) scale(1.1) rotate(-15deg); }
    }

    /* Parallax cloud animation */
    @keyframes cloudMove {
      0% { transform: translateX(-20px); }
      100% { transform: translateX(20px); }
    }

  </style>
</head>
<body>
  <div class="stage" id="stage">
    <div class="sky">
      <div class="sun"></div>
      <div class="clouds" id="clouds"></div>
    </div>

    <div class="buildings" id="buildings"></div>
    <div class="ground"></div>

    <div class="plane-wrap" id="planeWrap" aria-hidden="true">
      <div class="streak" id="streak"></div>

      <!-- Enhanced realistic jet SVG -->
      <svg class="plane" id="plane" viewBox="0 0 300 120" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="Modern jet">
        <defs>
          <linearGradient id="jet-body" x1="0%" x2="100%">
            <stop offset="0%" stop-color="#f7fbff"/>
            <stop offset="100%" stop-color="#d6e9ff"/>
          </linearGradient>
          <linearGradient id="jet-accent" x1="0%" x2="100%">
            <stop offset="0%" stop-color="#0b76ff"/>
            <stop offset="100%" stop-color="#0a58d1"/>
          </linearGradient>
          <linearGradient id="jet-engine" x1="0%" x2="100%">
            <stop offset="0%" stop-color="#ff6b35"/>
            <stop offset="100%" stop-color="#ff8c42"/>
          </linearGradient>
          <radialGradient id="jet-window">
            <stop offset="0%" stop-color="#9fc9ff"/>
            <stop offset="100%" stop-color="#6bb6ff"/>
          </radialGradient>
        </defs>

        <!-- Main fuselage -->
        <g transform="translate(10,8)">
          <!-- Fuselage body -->
          <path d="M20 58 Q60 34 160 28 Q220 26 260 44 Q200 52 160 66 Q110 78 40 70 Z" 
                fill="url(#jet-body)" stroke="#d0e9ff" stroke-width="1"/>
          
          <!-- Cockpit glass with reflection -->
          <path d="M155 30 q18 -2 32 6 q-6 8 -18 10 q-18 2 -26 -8 z" 
                fill="url(#jet-window)" opacity="0.96"/>
          
          <!-- Main wing -->
          <path d="M80 54 L20 30 L95 44 L88 68 Z" 
                fill="#eef6ff" stroke="#d6ecff"/>
          
          <!-- Tail wing -->
          <path d="M28 28 L22 12 L54 26 Z" 
                fill="url(#jet-accent)"/>
          
          <!-- Engine pods -->
          <g transform="translate(170,58)">
            <!-- Engine body -->
            <ellipse cx="20" cy="8" rx="22" ry="8" fill="url(#jet-engine)"/>
            <!-- Engine intake -->
            <rect x="-6" y="-6" width="40" height="18" rx="9" fill="#eaf6ff"/>
            <!-- Engine exhaust -->
            <ellipse cx="20" cy="8" rx="8" ry="4" fill="#ff5722" opacity="0.8"/>
          </g>
          
          <!-- Wing tip -->
          <path d="M260 44 L270 40 L275 48 Z" fill="#d6e9ff"/>
          
          <!-- Nose cone -->
          <path d="M10 58 Q5 56 8 52 L15 56 Z" fill="#0b76ff"/>
          
          <!-- Accent stripe -->
          <path d="M110 48 q40 -8 80 -2" 
                stroke="url(#jet-accent)" stroke-width="5" fill="none" stroke-linecap="round" opacity="0.95"/>
          
          <!-- Windows -->
          <circle cx="140" cy="36" r="3" fill="#6bb6ff" opacity="0.8"/>
          <circle cx="155" cy="34" r="3" fill="#6bb6ff" opacity="0.8"/>
          <circle cx="170" cy="33" r="3" fill="#6bb6ff" opacity="0.8"/>
        </g>
      </svg>

      <div id="contrails"></div>
    </div>

    <div class="money-wrap" id="moneyWrap"></div>

    <div class="crowd" id="crowd"></div>

    <div class="controls" id="controls">
      <div class="controls-row">
        <button id="startBtn">Start Flight</button>
        <button id="cashBtn" class="ghost">Cash Out</button>
        <button id="crashBtn" class="ghost">Force Crash</button>
      </div>
      <div class="controls-row">
        <div class="meter"> 
          <div style="font-size:12px;opacity:0.8">Multiplier</div> 
          <div id="mult" style="font-size:20px">1.00×</div>
        </div>
        <button id="mute" class="mute">🔊</button>
      </div>
    </div>

    <!-- Mobile controls -->
    <div class="mobile-controls" id="mobileControls" style="display: none;">
      <button class="mobile-btn" id="mobileStart">▶️</button>
      <button class="mobile-btn" id="mobileCash">💰</button>
      <button class="mobile-btn" id="mobileCrash">💥</button>
    </div>

    <div class="flash" id="flash"></div>
  </div>

  <script>
    // Elements
    const planeWrap = document.getElementById('planeWrap');
    const plane = document.getElementById('plane');
    const contrails = document.getElementById('contrails');
    const startBtn = document.getElementById('startBtn');
    const cashBtn = document.getElementById('cashBtn');
    const crashBtn = document.getElementById('crashBtn');
    const mobileStart = document.getElementById('mobileStart');
    const mobileCash = document.getElementById('mobileCash');
    const mobileCrash = document.getElementById('mobileCrash');
    const multEl = document.getElementById('mult');
    const streak = document.getElementById('streak');
    const flash = document.getElementById('flash');
    const moneyWrap = document.getElementById('moneyWrap');
    const crowd = document.getElementById('crowd');
    const buildings = document.getElementById('buildings');
    const mobileControls = document.getElementById('mobileControls');
    const mute = document.getElementById('mute');

    // State
    let running = false, crashed = false, startTime = 0, raf = null, muted = false;

    // Visual params - adjusted for mobile
    const params = { 
      baseSpeed: 0.35, 
      accel: 0.18, 
      maxTilt: -14, 
      minTilt: 6, 
      smokeInterval: 110,
      mobileSpeed: 0.28,
      mobileAccel: 0.15
    };

    // WebAudio setup (synthesized audio so no external files)
    const AudioCtx = window.AudioContext || window.webkitAudioContext;
    let ctx = null;
    let engineNode = null, windNode = null;

    function ensureAudio(){
      if(ctx) return;
      ctx = new AudioCtx();

      // master gain
      const master = ctx.createGain(); 
      master.gain.value = 0.9; 
      master.connect(ctx.destination);

      // engine: low rumble using oscillator + bandpass + gain
      const engineOsc = ctx.createOscillator(); 
      engineOsc.type = 'sawtooth'; 
      engineOsc.frequency.value = 40; // low
      const engineGain = ctx.createGain(); 
      engineGain.gain.value = 0.0; // start silent
      const engineBP = ctx.createBiquadFilter(); 
      engineBP.type = 'bandpass'; 
      engineBP.frequency.value = 120; 
      engineBP.Q.value = 0.6;
      engineOsc.connect(engineBP); 
      engineBP.connect(engineGain); 
      engineGain.connect(master);
      engineOsc.start();

      // wind: noise buffer -> filter -> gain
      const bufferSize = 2 * ctx.sampleRate;
      const noiseBuffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
      const data = noiseBuffer.getChannelData(0); 
      for (let i = 0; i < bufferSize; i++) 
        data[i] = (Math.random() * 2 - 1) * 0.5;
      const noiseSrc = ctx.createBufferSource(); 
      noiseSrc.buffer = noiseBuffer; 
      noiseSrc.loop = true;
      const windFilter = ctx.createBiquadFilter(); 
      windFilter.type = 'highpass'; 
      windFilter.frequency.value = 600; 
      windFilter.Q.value = 0.5;
      const windGain = ctx.createGain(); 
      windGain.gain.value = 0.0;
      noiseSrc.connect(windFilter); 
      windFilter.connect(windGain); 
      windGain.connect(master);
      noiseSrc.start();

      // exposed nodes
      engineNode = {osc: engineOsc, gain: engineGain, bp: engineBP};
      windNode = {src: noiseSrc, gain: windGain, filter: windFilter};
    }

    // Enhanced crowd cheer synthesized
    function playCheer(){
      if(muted) return;
      ensureAudio();
      const now = ctx.currentTime;

      // Bright tonal layer (multiple quick notes)
      for(let i=0;i<6;i++){
        const o = ctx.createOscillator(); 
        o.type='triangle'; 
        o.frequency.value = 440 + Math.random()*240 + i*20;
        const g = ctx.createGain(); 
        g.gain.value = 0.0001;
        o.connect(g); 
        g.connect(ctx.destination);
        o.start(now + i*0.02);
        g.gain.exponentialRampToValueAtTime(0.25, now + i*0.02 + 0.02);
        g.gain.exponentialRampToValueAtTime(0.0001, now + i*0.02 + 0.48);
        o.stop(now + i*0.02 + 0.5);
      }

      // Noise applause bursts
      const bufferSize = ctx.sampleRate * 0.35;
      const b = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
      const data = b.getChannelData(0); 
      for(let i=0;i<bufferSize;i++) 
        data[i] = (Math.random()*2-1)*Math.exp(-3*i/bufferSize);
      const src = ctx.createBufferSource(); 
      src.buffer=b; 
      const fl = ctx.createBiquadFilter(); 
      fl.type='lowpass'; 
      fl.frequency.value=3800;
      const g2 = ctx.createGain(); 
      g2.gain.value=0.8; 
      src.connect(fl); 
      fl.connect(g2); 
      g2.connect(ctx.destination);
      src.start(now);
      src.stop(now + 0.35);
    }

    // Money whoosh sound
    function playMoneyWhoosh(){
      if(muted) return; 
      ensureAudio();
      const now = ctx.currentTime;
      // Noise buffer
      const bufferSize = ctx.sampleRate * 0.6;
      const b = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
      const data = b.getChannelData(0); 
      for(let i=0;i<bufferSize;i++) 
        data[i] = (Math.random()*2-1); // white
      const src = ctx.createBufferSource(); 
      src.buffer=b; 
      const filt = ctx.createBiquadFilter(); 
      filt.type='highpass'; 
      filt.frequency.value=400;
      const g = ctx.createGain(); 
      g.gain.value = 0.0001; 
      src.connect(filt); 
      filt.connect(g); 
      g.connect(ctx.destination);
      src.start(now);
      g.gain.exponentialRampToValueAtTime(0.9, now + 0.06);
      g.gain.exponentialRampToValueAtTime(0.0001, now + 0.6);
      src.stop(now + 0.7);
    }

    // Enhanced crash explosion sound
    function playExplosion(){
      if(muted) return; 
      ensureAudio();
      const now = ctx.currentTime;
      
      // Deep explosion sound
      const o = ctx.createOscillator(); 
      o.type='sine'; 
      o.frequency.value=80; 
      const g = ctx.createGain(); 
      g.gain.value = 0.0001; 
      o.connect(g); 
      g.connect(ctx.destination);
      o.start(now); 
      g.gain.exponentialRampToValueAtTime(1.4, now + 0.06); 
      g.gain.exponentialRampToValueAtTime(0.0001, now + 0.9); 
      o.stop(now + 1.0);

      // Metal tearing sound
      const bufferSize = ctx.sampleRate * 0.8; 
      const b = ctx.createBuffer(1, bufferSize, ctx.sampleRate); 
      const data = b.getChannelData(0);
      for(let i=0;i<bufferSize;i++) 
        data[i] = (Math.random()*2-1)*Math.exp(-3*i/bufferSize);
      const src = ctx.createBufferSource(); 
      src.buffer=b; 
      const g2 = ctx.createGain(); 
      g2.gain.value=0.9; 
      const lp = ctx.createBiquadFilter(); 
      lp.type='lowpass'; 
      lp.frequency.value=2000;
      src.connect(lp); 
      lp.connect(g2); 
      g2.connect(ctx.destination);
      src.start(now); 
      src.stop(now + 0.8);
    }

    // Engine controls
    function setThrottle(v){ 
      if(!engineNode || !windNode) return; 
      engineNode.gain.gain.linearRampToValueAtTime(0.0001 + v*0.9, ctx.currentTime + 0.06); 
      engineNode.bp.frequency.linearRampToValueAtTime(80 + v*400, ctx.currentTime + 0.06); 
      windNode.gain.gain.linearRampToValueAtTime(v*0.9, ctx.currentTime + 0.06); 
      windNode.filter.frequency.linearRampToValueAtTime(400 + v*5000, ctx.currentTime + 0.06); 
    }

    // Utility: compute multiplier
    function computeMultiplier(t){ 
      const isMobile = window.innerWidth <= 520;
      const speed = isMobile ? params.mobileSpeed : params.baseSpeed;
      const accel = isMobile ? params.mobileAccel : params.accel;
      return Math.min(9999, (1 + (Math.exp(speed * t) - 1) * (1 + accel * t))); 
    }

    // Enhanced clouds creator
    function makeCloud(x,y,scale,opacity,zIndex){ 
      const c = document.createElement('div'); 
      c.className='cloud'; 
      c.style.width = 180 * scale + 'px'; 
      c.style.height = 90 * scale + 'px'; 
      c.style.left = x + '%'; 
      c.style.top = y + '%'; 
      c.style.opacity = opacity; 
      c.style.zIndex = zIndex; 
      document.getElementById('clouds').appendChild(c); 
      const dur = 30000 + Math.random()*30000; 
      c.animate([{transform:'translateX(0px)'},{transform:'translateX(' + (Math.random()*260-120) + 'px)'}],{
        duration:dur,
        iterations:Infinity,
        direction:'alternate',
        easing:'ease-in-out'
      }); 
    }
    for(let i=0;i<3;i++) 
      makeCloud(2+Math.random()*90,3+Math.random()*55,0.6+Math.random()*1.2,0.5+Math.random()*0.5,i%2?1:2);

    // Create buildings
    function makeBuildings() {
      for (let i = 0; i < 8; i++) {
        const building = document.createElement('div');
        building.className = 'building';
        building.style.height = (40 + Math.random() * 40) + '%';
        building.style.width = (6 + Math.random() * 4) + '%';
        buildings.appendChild(building);
      }
    }
    makeBuildings();

    // Enhanced crowd silhouettes
    function makeCrowd(){ 
      for(let i=0;i<26;i++){ 
        const p = document.createElement('div'); 
        p.className='person'; 
        p.style.height = (12 + Math.random()*18) + 'px'; 
        p.style.width = (6 + Math.random()*6) + 'px'; 
        p.style.opacity = 0.5 + Math.random()*0.4; 
        crowd.appendChild(p); 
      } 
    }
    makeCrowd();

    // Enhanced contrail generator
    function createContrail(x,y,scale){ 
      const c = document.createElement('div'); 
      c.style.position='absolute'; 
      c.style.left = x + 'px'; 
      c.style.top = y + 'px'; 
      c.style.width = (6*scale) + 'px'; 
      c.style.height = (6*scale) + 'px'; 
      c.style.borderRadius='50%'; 
      c.style.background='rgba(255,255,255,0.85)'; 
      c.style.filter='blur(2px)'; 
      c.style.opacity=0.9; 
      contrails.appendChild(c); 
      
      // Enhanced animation with more realistic movement
      c.animate([
        {transform:'translateY(0px) scale(1)',opacity:0.9},
        {transform:'translateY(-160px) scale(2)',opacity:0}
      ],{
        duration:1600 + Math.random()*600,
        easing:'cubic-bezier(.2,.8,.2,1)'
      }); 
      setTimeout(()=>c.remove(),2200);
    }

    // Enhanced money visuals
    function spawnMoneyBurst(){ 
      const n = 15 + Math.floor(Math.random()*10); 
      for(let i=0;i<n;i++){ 
        const b = document.createElement('div'); 
        b.className='bill'; 
        moneyWrap.appendChild(b); 
        const startX = (Math.random()*260 - 130); 
        b.style.left = (startX) + 'px'; 
        b.style.top = (Math.random()*40) + 'px'; 
        b.textContent = 'KSh'; // Kenyan Shilling
        
        // Enhanced animation
        const dur = 1100 + Math.random()*700; 
        b.style.animation = `floatUp ${dur}ms cubic-bezier(.2,.8,.2,1)`; 
        b.style.transformOrigin='center';
        
        // Add slight horizontal sweep
        b.animate([
          {transform:'translateX(0) rotate(0deg)'},
          {transform:`translateX(${(Math.random()*360-180)}px) rotate(${(Math.random()*720-360)}deg)`}
        ],{
          duration:dur,
          easing:'linear'
        }); 
        setTimeout(()=> b.remove(), dur+80); 
      } 
    }

    // Enhanced money whoosh visuals
    function spawnMoneySwoosh(){ 
      const n = 8; 
      for(let i=0;i<n;i++){ 
        const b = document.createElement('div'); 
        b.className='bill'; 
        moneyWrap.appendChild(b); 
        b.style.left = (i*48 - 140) + 'px'; 
        b.style.top = (20 + Math.random()*40) + 'px'; 
        b.textContent = '$'; 
        b.style.animation = `swooshLeft ${900 + Math.random()*300}ms cubic-bezier(.2,.8,.2,1)`; 
        setTimeout(()=> b.remove(), 1300); 
      } 
    }

    // Enhanced tick loop
    function tick(now){ 
      if(!running) return; 
      if(!startTime) startTime = now; 
      const t = (now - startTime)/1000; 
      let mult = computeMultiplier(t); 
      multEl.textContent = mult.toFixed(2) + '×';
      
      // Enhanced position calculations
      const heightPct = Math.min(140, Math.pow(mult,0.55) * 3.6);
      const translateY = - (heightPct); 
      const scale = 1 + Math.min(2.2, Math.log(mult+1)*0.18);
      const tilt = Math.max(params.maxTilt, params.minTilt - Math.log(mult+1)*7);
      
      // Apply transformations
      planeWrap.style.transform = `translate(-50%, ${translateY}vh) scale(${scale}) rotate(${tilt}deg)`;
      
      // Enhanced streak effect
      streak.style.transform = `scaleX(${Math.min(3.4, Math.log(mult+1)*0.78)}) translateX(-40px) rotate(${tilt/6}deg)`;
      streak.style.opacity = Math.max(0.06, Math.min(0.72, Math.log(mult+1)*0.08));
      
      // Enhanced contrails
      if(Math.floor(now/params.smokeInterval) % 2 === 0){ 
        const rect = plane.getBoundingClientRect(); 
        createContrail(rect.left + rect.width*0.06, rect.top + rect.height*0.6, 1 + Math.random()*0.6); 
      }
      
      // Audio throttle by multiplier progression
      const throttle = Math.min(1, Math.log(mult+1)/3.2 + 0.02);
      if(ctx) setThrottle(throttle);
      
      // Random crash chance (extremely low)
      if(!crashed && Math.random() < 0.0006 && t>1.6){ 
        triggerCrash(now); 
      }
      
      raf = requestAnimationFrame(tick);
    }

    // Enhanced start function
    function start(){ 
      if(running) return; 
      running=true; 
      crashed=false; 
      startTime=0; 
      startBtn.textContent='In Flight'; 
      startBtn.disabled=true; 
      cashBtn.disabled=false; 
      crashBtn.disabled=false;
      mobileStart.textContent='✈️';
      mobileCash.disabled=false;
      mobileCrash.disabled=false;
      
      if(!ctx) ensureAudio(); 
      
      // Enhanced startup ramp
      setThrottle(0.12);
      setTimeout(()=> setThrottle(0.42), 220);
      
      // Enhanced takeoff animation
      planeWrap.animate([
        { transform: 'translate(-50%, 0vh) scale(0.95) rotate(6deg)', offset:0},
        { transform: 'translate(-50%, -6vh) scale(1.02) rotate(-8deg)', offset:0.6},
        { transform: 'translate(-50%, -10vh) scale(1.06) rotate(-10deg)', offset:1}
      ],{
        duration:640,
        easing:'cubic-bezier(.2,.8,.2,1)'
      });
      
      raf = requestAnimationFrame(tick);
    }

    // Enhanced cash out function
    function cashOut(){ 
      if(!running || crashed) return; 
      running=false; 
      cancelAnimationFrame(raf); 
      startBtn.textContent='Start Flight'; 
      startBtn.disabled=false; 
      cashBtn.disabled=true; 
      crashBtn.disabled=true;
      mobileStart.textContent='▶️';
      mobileCash.disabled=true;
      mobileCrash.disabled=true;
      
      // Enhanced sound effects
      playCheer(); 
      playMoneyWhoosh(); 
      spawnMoneyBurst(); 
      spawnMoneySwoosh();
      
      // Enhanced audio throttle ramp down
      if(ctx) setThrottle(0.65);
      
      // Enhanced plane animation
      const flyUp = planeWrap.animate([
        { transform: planeWrap.style.transform || 'translate(-50%, -10vh) scale(1.06) rotate(-10deg)', opacity:1},
        { transform: 'translate(-50%, -160vh) scale(1.6) rotate(-20deg)', opacity:0}
      ],{
        duration:1000,
        easing:'cubic-bezier(.08,.9,.1,1)'
      });
      
      // Enhanced flash effect
      flash.style.transition='opacity 340ms ease-out'; 
      flash.style.opacity=0.18;
      setTimeout(()=>{ flash.style.opacity=0; },300);
      
      flyUp.onfinish = ()=>{ 
        planeWrap.style.transform = 'translate(-50%, 0vh) scale(1) rotate(6deg)'; 
        multEl.textContent='1.00×'; 
        if(ctx) setThrottle(0.0); 
      };
    }

    // Enhanced crash function
    function triggerCrash(now){ 
      if(crashed) return; 
      crashed=true; 
      running=false; 
      cancelAnimationFrame(raf); 
      startBtn.textContent='Start Flight'; 
      startBtn.disabled=false; 
      cashBtn.disabled=true; 
      crashBtn.disabled=true;
      mobileStart.textContent='▶️';
      mobileCash.disabled=true;
      mobileCrash.disabled=true;
      
      playExplosion(); 
      
      // Enhanced audio effects
      if(ctx) setThrottle(0.0);
      
      // Enhanced crash animation
      const wob = planeWrap.animate([
        { transform: planeWrap.style.transform || 'translate(-50%, -10vh) scale(1.06) rotate(-10deg)' , offset:0},
        { transform: 'translate(-45%, -10vh) scale(1.08) rotate(8deg)', offset:0.25},
        { transform: 'translate(-55%, -40vh) scale(1.1) rotate(40deg)', offset:0.6},
        { transform: 'translate(-120%, 110vh) scale(0.7) rotate(90deg)', opacity:0, offset:1}
      ],{
        duration:900,
        easing:'cubic-bezier(.2,.1,.2,1)'
      });
      
      // Enhanced flash effect
      flash.style.transition='opacity 200ms'; 
      flash.style.opacity=0.55; 
      setTimeout(()=>{ flash.style.opacity=0.0; },240);
      
      // Enhanced contrail puff
      const rect = plane.getBoundingClientRect(); 
      for(let i=0;i<8;i++){ 
        setTimeout(()=> 
          createContrail(rect.left + rect.width*0.06, rect.top + rect.height*0.56, 1.8 + Math.random()*1.2), 
          i*80
        ); 
      }
      
      setTimeout(()=>{ 
        multEl.textContent='1.00×'; 
        planeWrap.style.transform='translate(-50%, 0vh) scale(1) rotate(6deg)'; 
        crashed=false; 
        if(ctx) setThrottle(0.0); 
      }, 1400);
    }

    // Event wiring
    startBtn.addEventListener('click', ()=>{ 
      // Resume audio on first user gesture (browsers require gesture)
      if(!ctx) try{ ensureAudio(); }catch(e){}
      start();
    });
    
    cashBtn.addEventListener('click', cashOut);
    crashBtn.addEventListener('click', ()=> triggerCrash(performance.now()));
    
    // Mobile controls
    mobileStart.addEventListener('click', start);
    mobileCash.addEventListener('click', cashOut);
    mobileCrash.addEventListener('click', ()=> triggerCrash(performance.now()));

    // Mute toggle
    mute.addEventListener('click', ()=>{ 
      muted = !muted; 
      mute.textContent = muted ? '🔇' : '🔊'; 
      if(ctx) { 
        ctx.destination.gain && (ctx.destination.gain.value = muted ? 0 : 1); 
      } 
    });

    // Keyboard controls
    window.addEventListener('keydown', (e)=>{ 
      if(e.key === ' '){ 
        e.preventDefault(); 
        if(!running) start(); 
        else cashOut(); 
      } 
      if(e.key==='c'){ 
        triggerCrash(performance.now()); 
      } 
    });

    // Touch controls for mobile
    let touchStartY = 0;
    document.addEventListener('touchstart', (e) => {
      touchStartY = e.touches[0].clientY;
    });
    
    document.addEventListener('touchend', (e) => {
      const touchEndY = e.changedTouches[0].clientY;
      const diff = touchStartY - touchEndY;
      
      // Swipe up to cash out
      if (diff > 50 && running) {
        cashOut();
      }
      // Swipe down to crash
      else if (diff < -50 && running) {
        triggerCrash(performance.now());
      }
    });

    // Initial state
    planeWrap.style.transform = 'translate(-50%, 0vh) scale(1) rotate(6deg)'; 
    cashBtn.disabled = true; 
    crashBtn.disabled = true;
    mobileCash.disabled = true;
    mobileCrash.disabled = true;
    
    // Show mobile controls on small screens
    if (window.innerWidth <= 520) {
      mobileControls.style.display = 'flex';
    }
    
    // Resize behavior
    window.addEventListener('resize', ()=>{ 
      planeWrap.style.transition='none'; 
      setTimeout(()=>planeWrap.style.transition='transform 160ms linear',40); 
    });

  </script>
</body>
</html>