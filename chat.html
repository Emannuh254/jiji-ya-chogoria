<!DOCTYPE html>
<html>
<head>
    <title>Jiji ya Chogoria - Chat</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7"></script>
    <link rel="stylesheet" href="index.css">
</head>
<body>
    <header>
        <div class="container">
            <nav class="navbar">
                <a href="dashboard.html" class="logo">Jiji ya Chogoria</a>
                <ul class="nav-links">
                    <li><a href="dashboard.html" class="dashboard">Dashboard</a></li>
                    <li><a href="chat.html" class="chat active">Chat</a></li>
                    <li><a href="post-product.html" class="post product">Post product üõí</a></li>
                    <li><a href="settings.html" class="settings">Settings</a></li>
                    <li><a href="#" class="logout" id="logout-btn">Logout</a></li>
                </ul>
                <a href="post-product.html" class="post-product-btn">Post Product</a>
                <button class="mobile-menu-toggle" id="mobile-menu-toggle">‚ò∞</button>
            </nav>
        </div>
    </header>
    
    <main class="container">
        <div id="user-info">
            <span id="user-name"></span>
        </div>
        
        <div id="status-section">
            <h3>Statuses (Coming Soon)</h3>
            <p>Status feature will be available in future updates</p>
        </div>
        
        <div id="chat-section">
            <h2 id="chat-title">Community Chat</h2>
            <div id="messages-container"></div>
            <form id="message-form">
                <input type="text" id="message-input" placeholder="Type a message..." required>
                <button type="submit">Send</button>
            </form>
        </div>
    </main>

    <footer>
        <div class="container">
            <p>&copy; 2025 Jiji ya Chogoria by mannuh. All rights reserved.</p>
        </div>
    </footer>

    <script>
        // Initialize Supabase
        const supabaseUrl = 'https://lrezerxsbuekkhmpverr.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxyZXplcnhzYnVla2tobXB2ZXJyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgzNTI3MjMsImV4cCI6MjA3MzkyODcyM30.96senppPRMHveFi2ouDPDqhh17XIwxsLvA4U0rvjU9g';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        // Mobile menu toggle
        const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
        const navLinks = document.querySelector('.nav-links');

        mobileMenuToggle.addEventListener('click', () => {
            navLinks.classList.toggle('active');
        });

        // Close mobile menu when clicking on a link
        document.querySelectorAll('.nav-links a').forEach(link => {
            link.addEventListener('click', () => {
                navLinks.classList.remove('active');
            });
        });

        // Toast notification function
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // Check authentication
        async function checkAuth() {
            const { data: { user }, error } = await supabase.auth.getUser();
            if (!user) {
                window.location.href = 'index.html';
                return null;
            }
            
            // Display user name
            document.getElementById('user-name').textContent = 
                `Welcome, ${user.user_metadata?.full_name || user.email}`;
            return user;
        }

        // Load messages
        async function loadMessages() {
            const { data: userData } = await supabase.auth.getUser();
            const currentUserId = userData?.user?.id;
            
            const { data, error } = await supabase
                .from('messages')
                .select(`
                    *,
                    profiles(full_name)
                `)
                .order('created_at', { ascending: true });
            
            if (error) {
                console.error('Error loading messages:', error);
                showToast('Error loading messages', 'error');
                return;
            }
            
            const messagesContainer = document.getElementById('messages-container');
            messagesContainer.innerHTML = '';
            
            if (data.length === 0) {
                messagesContainer.innerHTML = '<p>No messages yet. Start the conversation! üòä</p>';
                return;
            }
            
            data.forEach(message => {
                const messageEl = document.createElement('div');
                messageEl.className = 'message';
                
                // Add delete button only for message owner
                const deleteButton = currentUserId === message.user_id 
                    ? `<button class="delete-btn" data-id="${message.id}">üóëÔ∏è</button>`
                    : '';
                
                messageEl.innerHTML = `
                    <div class="message-content">
                        <strong>${message.profiles?.full_name || 'Unknown'}:</strong> ${message.content}
                        <small>${new Date(message.created_at).toLocaleString()}</small>
                    </div>
                    ${deleteButton}
                `;
                messagesContainer.appendChild(messageEl);
            });
            
            // Scroll to bottom
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            // Add event listeners for delete buttons
            document.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', async () => {
                    const messageId = button.getAttribute('data-id');
                    if (confirm('Are you sure you want to delete this message?')) {
                        await deleteMessage(messageId);
                    }
                });
            });
        }

        // Delete message
        async function deleteMessage(messageId) {
            const { error } = await supabase
                .from('messages')
                .delete()
                .eq('id', messageId);
            
            if (error) {
                showToast('Error deleting message: ' + error.message, 'error');
            } else {
                showToast('Message deleted successfully! üóëÔ∏è');
                loadMessages();
            }
        }

        // Send a message
        document.getElementById('message-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const user = await checkAuth();
            if (!user) return;
            
            const content = document.getElementById('message-input').value;
            
            const { data, error } = await supabase
                .from('messages')
                .insert([{
                    content,
                    user_id: user.id
                }]);
            
            if (error) {
                showToast('Error sending message: ' + error.message, 'error');
            } else {
                document.getElementById('message-input').value = '';
                loadMessages();
            }
        });

        // Logout
        document.getElementById('logout-btn').addEventListener('click', async () => {
            await supabase.auth.signOut();
            showToast('üëã Logged out successfully');
            setTimeout(() => {
                window.location.href = 'index.html';
            }, 1000);
        });

        // Initialize
        checkAuth().then(async (user) => {
            if (!user) return;
            
            // Check if we're coming from a product page
            const sellerId = sessionStorage.getItem('chatSellerId');
            const sellerName = sessionStorage.getItem('chatSellerName');
            const productTitle = sessionStorage.getItem('chatProductTitle');
            
            if (sellerId && sellerName && productTitle) {
                // Update chat title
                document.getElementById('chat-title').textContent = `Chat with ${sellerName} about: ${productTitle}`;
                
                // Pre-fill message input
                document.getElementById('message-input').value = `Hi ${sellerName}, I'm interested in your product: ${productTitle}`;
                
                // Clear sessionStorage
                sessionStorage.removeItem('chatSellerId');
                sessionStorage.removeItem('chatSellerName');
                sessionStorage.removeItem('chatProductTitle');
            }
            
            loadMessages();
            
            // Real-time subscription for new messages and deletions
            supabase
                .channel('messages')
                .on('postgres_changes', { 
                    event: '*', 
                    schema: 'public', 
                    table: 'messages' 
                }, payload => {
                    loadMessages();
                })
                .subscribe();
        });
    </script>
</body>
</html>