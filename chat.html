<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üí¨ Chat | Jiji ya Chogoria</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* ====== CSS Variables ====== */
        :root {
            --bg-primary: #000;
            --bg-secondary: #111;
            --bg-chat: #222;
            --bg-message-sent: #ff6600;
            --bg-message-received: #333;
            --text-primary: #fff;
            --text-secondary: #ccc;
            --accent: #ff6600;
            --success: #0f0;
            --error: #ff3300;
            --border-radius: 12px;
            --button-radius: 20px;
            --sidebar-width: 300px;
            --header-height: 60px;
            --transition: 0.2s ease;
            --shadow: rgba(255, 102, 0, 0.3);
            --border-color: #222;
        }

        /* ====== Reset & Base ====== */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        body { background: var(--bg-primary); color: var(--text-primary); min-height: 100vh; display: flex; flex-direction: column; font-size: 14px; }

        /* ====== Container ====== */
        .container { max-width: 1024px; margin: 0 auto; padding: 0 12px; width: 100%; }

        /* ====== Header ====== */
        header { background: var(--bg-secondary); border-bottom: 1px solid var(--bg-chat); position: sticky; top: 0; z-index: 10; }

        /* ====== Navbar ====== */
        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            position: relative;
            z-index: 20;
        }

        .navbar .logo {
            font-size: 1.6rem;
            font-weight: 700;
            color: var(--accent);
            text-decoration: none;
            display: flex;
            align-items: center;
            transition: var(--transition);
        }

        .navbar .logo:hover {
            transform: scale(1.05);
        }

        .navbar .logo::before { 
            content: "üí¨"; 
            margin-right: 8px; 
        }

        .nav-links {
            display: flex;
            list-style: none;
            gap: 12px;
            transition: var(--transition);
        }

        .nav-links a {
            color: var(--text-primary);
            text-decoration: none;
            padding: 8px 16px;
            border-radius: var(--button-radius);
            font-weight: 600;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-links a:hover {
            background: var(--bg-chat);
            color: var(--accent);
            transform: translateY(-2px);
        }

        .nav-links a.active {
            background: var(--accent);
            color: var(--bg-primary);
        }

        .nav-links a::before {
            font-size: 1.3rem;
        }

        .nav-links a.dashboard::before {
            content: "üè†";
        }

        .nav-links a.chat::before {
            content: "üí¨";
        }

        .nav-links a.product::before {
            content: "‚ûï";
        }

        .nav-links a.settings::before {
            content: "‚öôÔ∏è";
        }

        .nav-links a.logout::before {
            content: "üö™";
        }

        .mobile-menu-toggle {
            display: none;
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 1.8rem;
            cursor: pointer;
            transition: var(--transition);
            padding: 5px;
            border-radius: 8px;
        }

        .mobile-menu-toggle:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        /* Mobile */
        @media (max-width: 768px) {
            .mobile-menu-toggle { display: block; }

            .nav-links {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100vh;
                background-color: rgba(0, 0, 0, 0.95);
                flex-direction: column;
                align-items: center;
                justify-content: center;
                gap: 20px;
                padding-top: 60px;
                transform: translateY(-100%);
                transition: transform 0.3s ease;
                z-index: 9999;
            }

            .nav-links.active {
                transform: translateY(0);
            }

            .nav-links a {
                color: #FFA500;
                font-size: 1.5rem;
                text-decoration: none;
                transition: color 0.2s;
                width: 100%;
                text-align: center;
                padding: 16px 0;
            }

            .nav-links a:hover {
                color: #ffcc66;
                background: none;
            }
        }

        /* ====== Chat Container ====== */
        .chat-container { display: flex; flex: 1; min-height: calc(100vh - var(--header-height)); }

        /* ====== Sidebar ====== */
        .sidebar { width: var(--sidebar-width); background: var(--bg-secondary); border-right: 1px solid var(--bg-chat); display: flex; flex-direction: column; transition: transform var(--transition); }
        .sidebar.hidden { transform: translateX(-100%); }
        .tab-btns { display: flex; border-bottom: 1px solid var(--bg-chat); }
        .tab-btn { flex: 1; padding: 12px; background: none; border: none; color: var(--text-secondary); font-weight: 600; cursor: pointer; transition: var(--transition); }
        .tab-btn.active { color: var(--accent); border-bottom: 2px solid var(--accent); }
        .search-container { padding: 12px; }
        .search-input { width: 100%; padding: 10px; border-radius: var(--button-radius); border: none; background: var(--bg-chat); color: var(--text-primary); font-size: 0.9rem; outline: none; }
        .search-input:focus { border: 1px solid var(--accent); }
        .conversations-container { flex: 1; overflow-y: auto; padding: 8px; }
        .conversation { display: flex; align-items: center; padding: 8px; border-radius: var(--border-radius); cursor: pointer; transition: var(--transition); margin-bottom: 6px; }
        .conversation:hover { background: var(--bg-chat); }
        .conversation-avatar { width: 40px; height: 40px; border-radius: 50%; background: var(--accent); color: var(--bg-primary); display: flex; align-items: center; justify-content: center; font-weight: 700; margin-right: 10px; position: relative; }
        .conversation-avatar.online::after { content: ''; position: absolute; bottom: 0; right: 0; width: 8px; height: 8px; background: var(--success); border-radius: 50%; border: 2px solid var(--bg-secondary); }
        .conversation-details { flex: 1; overflow: hidden; }
        .conversation-header { display: flex; justify-content: space-between; }
        .conversation-name { font-weight: 600; font-size: 0.9rem; color: var(--accent); }
        .conversation-preview { font-size: 0.85rem; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .conversation-time { font-size: 0.8rem; color: var(--text-secondary); }
        .unread-indicator { background: var(--accent); color: var(--bg-primary); font-size: 0.8rem; padding: 2px 6px; border-radius: var(--button-radius); }

        /* ====== Chat Area ====== */
        .chat-area { flex: 1; display: flex; flex-direction: column; }
        .chat-header { display: none; align-items: center; padding: 12px; border-bottom: 1px solid var(--bg-chat); background: var(--bg-secondary); }
        .back-btn { display: none; background: none; border: none; color: var(--text-primary); font-size: 1.2rem; cursor: pointer; margin-right: 10px; }
        .chat-user-avatar { width: 36px; height: 36px; border-radius: 50%; background: var(--accent); color: var(--bg-primary); display: flex; align-items: center; justify-content: center; font-weight: 700; margin-right: 8px; position: relative; }
        .chat-user-avatar.online::after { content: ''; position: absolute; bottom: 0; right: 0; width: 8px; height: 8px; background: var(--success); border-radius: 50%; border: 2px solid var(--bg-secondary); }
        .chat-user-name { font-weight: 600; font-size: 1rem; color: var(--accent); }
        .chat-user-status { font-size: 0.8rem; color: var(--text-secondary); }
        .messages-container { flex: 1; overflow-y: auto; padding: 12px; display: flex; flex-direction: column; gap: 8px; }
        .message { max-width: 75%; padding: 8px 12px; border-radius: var(--border-radius); }
        .message.sent { background: var(--bg-message-sent); color: var(--bg-primary); align-self: flex-end; border-bottom-right-radius: 2px; font-size: 1.1rem; }
        .message.received { background: var(--bg-message-received); color: var(--text-primary); align-self: flex-start; border-bottom-left-radius: 2px; font-size: 1.1rem; }
        .message-header { font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 4px; display: flex; justify-content: space-between; }
        .message-content { font-size: 0.9rem; }
        .message-time { font-size: 0.75rem; color: var(--text-secondary); text-align: right; margin-top: 2px; }
        .delete-btn { background: none; border: none; color: var(--error); cursor: pointer; font-size: 0.8rem; opacity: 0; transition: var(--transition); }
        .message:hover .delete-btn { opacity: 1; }

        /* ====== Input Area ====== */
        .message-input-container { display: none; padding: 12px; border-top: 1px solid var(--bg-chat); background: var(--bg-secondary); }
        .message-form { display: flex; gap: 8px; }
        .message-input { flex: 1; padding: 10px; border-radius: var(--button-radius); border: none; background: var(--bg-chat); color: var(--text-primary); font-size: 0.9rem; outline: none; }
        .message-input:focus { border: 1px solid var(--accent); }
        .send-btn { padding: 10px 16px; background: var(--accent); border: none; border-radius: var(--button-radius); color: var(--bg-primary); font-weight: 600; cursor: pointer; transition: var(--transition); }
        .send-btn:hover { transform: scale(1.05); }

        /* ====== Loading & Empty ====== */
        .loading-spinner, .no-messages, .no-conversations, .error-message { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: var(--text-secondary); font-size: 1rem; text-align: center; }
        .loading-spinner::before { content: ''; width: 24px; height: 24px; border: 3px solid var(--bg-chat); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 8px; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* ====== Toast ====== */
        .toast { position: fixed; bottom: 16px; left: 50%; transform: translateX(-50%); padding: 10px 16px; border-radius: var(--button-radius); color: var(--bg-primary); font-weight: 600; display: flex; align-items: center; gap: 8px; z-index: 1000; animation: slideIn 0.3s ease, slideOut 0.3s ease 2.7s forwards; }
        .toast.success { background: var(--accent); }
        .toast.error { background: var(--error); }
        @keyframes slideIn { from { transform: translateX(-50%) translateY(20px); opacity: 0; } to { transform: translateX(-50%); opacity: 1; } }
        @keyframes slideOut { to { opacity: 0; } }

        /* ====== Footer ====== */
        footer { background: var(--bg-secondary); padding: 30px 0; text-align: center; border-top: 1px solid var(--border-color); margin-top: auto; box-shadow: 0 -2px 10px var(--shadow); }
        footer p { color: var(--text-secondary); font-size: 1.2rem; display: flex; align-items: center; justify-content: center; gap: 10px; }
        footer p::before { content: "¬©"; font-size: 1.3rem; }

        /* ====== Mobile ====== */
        @media (max-width: 768px) {
            .chat-container { flex-direction: column; }
            .sidebar { width: 100%; height: 40vh; position: fixed; z-index: 10; }
            .chat-area { height: calc(100vh - var(--header-height)); }
            .back-btn { display: block; }
            .conversation, .message { font-size: 0.85rem; }
        }

        @media (max-width: 480px) {
            body { font-size: 17px; }
            .post-title { font-size: 1.3rem; }
            .post-price { font-size: 1.4rem; }
            .chat-seller-btn { padding: 10px 16px; font-size: 1.1rem; }
            .seller-avatar { width: 44px; height: 44px; font-size: 1.3rem; }
            .seller-name { font-size: 1.2rem; }
            .toast { right: 15px; left: 15px; min-width: auto; }
            
            /* Improved mobile menu for small screens */
            .mobile-menu-toggle {
                font-size: 2.2rem;
                padding: 12px;
            }
            
            .nav-links a {
                font-size: 1.8rem;
                padding: 20px 0;
            }
        }

        /* ====== Performance Optimizations ====== */
        @media (prefers-reduced-motion: reduce) {
            * { transition-duration: 0.01ms !important; animation-duration: 0.01ms !important; animation-iteration-count: 1 !important; }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <nav class="navbar" role="navigation">
                <a href="dashboard.html" class="logo" aria-label="Jiji ya Chogoria Home">Jiji ya Chogoria</a>
                <button class="mobile-menu-toggle" id="mobile-menu-toggle" aria-label="Toggle menu">‚ò∞</button>
                <ul class="nav-links" id="nav-links">
                    <li><a href="dashboard.html" aria-label="Dashboard">Dashboard</a></li>
                    <li><a href="chat.html" class="active" aria-label="Chat">Chat</a></li>
                    <li><a href="post-product.html" aria-label="Post Product">Post Product</a></li>
                    <li><a href="settings.html" aria-label="Settings">Settings</a></li>
                    <li><a href="#" id="logout-btn" aria-label="Logout">Logout</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <div class="chat-container container">
        <aside class="sidebar" id="sidebar" aria-label="Conversations">
            <div class="tab-btns">
                <button class="tab-btn active" data-tab="inbox" aria-label="Inbox">Inbox</button>
                <button class="tab-btn" data-tab="community" aria-label="Community">Community</button>
            </div>
            <div class="search-container">
                <input type="text" class="search-input" id="search-input" placeholder="Search conversations..." aria-label="Search conversations">
            </div>
            <div class="conversations-container" id="conversations-container" role="list"></div>
        </aside>

        <section class="chat-area" aria-label="Chat area">
            <div class="chat-header" id="chat-header">
                <button class="back-btn" id="back-to-inbox" aria-label="Back to conversations">‚Üê</button>
                <div class="chat-user-avatar" id="chat-user-avatar" aria-hidden="true">U</div>
                <div class="chat-user-info">
                    <div class="chat-user-name" id="chat-user-name">Username</div>
                    <div class="chat-user-status" id="chat-user-status">Offline</div>
                </div>
            </div>
            <div class="messages-container" id="messages-container" role="log" aria-live="polite"></div>
            <div class="message-input-container" id="message-input-container">
                <form class="message-form" id="message-form" role="form">
                    <input type="text" class="message-input" id="message-input" placeholder="Type your message..." aria-label="Type a message">
                    <button type="submit" class="send-btn" aria-label="Send message">Send</button>
                </form>
            </div>
        </section>
    </div>

    <footer>
        <p><b>KHAMIC.inc</b> 2025</p>
    </footer>

    <script>
        // Initialize Supabase with the correct credentials
        const supabaseUrl = 'https://lrezerxsbuekkhmpverr.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxyZXplcnhzYnVla2tobXB2ZXJyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgzNTI3MjMsImV4cCI6MjA3MzkyODcyM30.96senppPRMHveFi2ouDPDqhh17XIwxsLvA4U0rvjU9g';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        const elements = {
            mobileMenuToggle: document.getElementById('mobile-menu-toggle'),
            navLinks: document.getElementById('nav-links'),
            sidebar: document.getElementById('sidebar'),
            conversationsContainer: document.getElementById('conversations-container'),
            messagesContainer: document.getElementById('messages-container'),
            messageForm: document.getElementById('message-form'),
            messageInput: document.getElementById('message-input'),
            messageInputContainer: document.getElementById('message-input-container'),
            chatHeader: document.getElementById('chat-header'),
            chatUserAvatar: document.getElementById('chat-user-avatar'),
            chatUserName: document.getElementById('chat-user-name'),
            chatUserStatus: document.getElementById('chat-user-status'),
            backToInboxBtn: document.getElementById('back-to-inbox'),
            logoutBtn: document.getElementById('logout-btn'),
            searchInput: document.getElementById('search-input'),
            tabBtns: document.querySelectorAll('.tab-btn')
        };

        let currentUser = null, activeTab = 'inbox', activeConversation = null, onlineUsers = new Set(), page = 1, pageSize = 20;

        const isMobile = () => window.innerWidth <= 768;

        const debounce = (fn, delay) => {
            let timeout;
            return (...args) => {
                clearTimeout(timeout);
                timeout = setTimeout(() => fn(...args), delay);
            };
        };

        const escapeHtml = text => {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        };

        // --- NAVBAR TOGGLE (Fixed to match settings.html) ---
        elements.mobileMenuToggle.addEventListener('click', () => {
            const isActive = elements.navLinks.classList.toggle('active');
            document.body.style.overflow = isActive ? 'hidden' : '';
        });

        // Close mobile menu when clicking on a link
        elements.navLinks.querySelectorAll('a').forEach(link => {
            link.addEventListener('click', () => {
                elements.navLinks.classList.remove('active');
                document.body.style.overflow = '';
            });
        });

        // --- UTILITIES ---
        const formatTime = dateString => {
            const date = new Date(dateString), now = new Date();
            if (date.toDateString() === now.toDateString()) return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const yesterday = new Date(now); yesterday.setDate(yesterday.getDate() - 1);
            if (date.toDateString() === yesterday.toDateString()) return 'Yesterday';
            return date.toLocaleDateString([], { month: 'short', day: 'numeric' });
        };

        const showToast = (message, type = 'success') => {
            document.querySelectorAll('.toast').forEach(t => t.remove());
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<span>${type === 'success' ? '‚úÖ' : '‚ùå'}</span> ${message}`;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        };

        // --- AUTH CHECK (Fixed to match settings.html) ---
        async function checkAuth() {
            try {
                const { data: { user }, error } = await supabase.auth.getUser();
                if (!user) {
                    showToast('Please log in to access chat', 'error');
                    window.location.href = 'index.html';
                    return null;
                }
                
                return user;
            } catch (error) {
                console.error('Authentication error:', error);
                showToast('Authentication failed. Please log in again.', 'error');
                window.location.href = 'index.html';
                return null;
            }
        }

        // --- LOAD CONVERSATIONS ---
        async function loadConversations(searchTerm = '') {
            elements.conversationsContainer.innerHTML = '<div class="loading-spinner"></div>';

            try {
                if (activeTab === 'inbox') {
                    // Fetch private conversations
                    const { data: messages, error } = await supabase
                        .from('messages')
                        .select('*, profiles!messages_recipient_id_fkey(full_name)')
                        .or(`user_id.eq.${currentUser.id},recipient_id.eq.${currentUser.id}`)
                        .eq('is_private', true)
                        .order('created_at', { ascending: false });

                    if (error) throw error;

                    // Group messages by the other user
                    const conversationsMap = new Map();
                    messages.forEach(msg => {
                        const otherUserId = msg.user_id === currentUser.id ? msg.recipient_id : msg.user_id;
                        if (!conversationsMap.has(otherUserId)) {
                            conversationsMap.set(otherUserId, {
                                id: otherUserId,
                                name: msg.profiles?.full_name || 'Unknown',
                                lastMessage: msg.content,
                                lastMessageTime: msg.created_at,
                                unread: msg.user_id !== currentUser.id && !msg.is_read
                            });
                        }
                    });

                    let conversations = Array.from(conversationsMap.values());

                    // Filter by search term if provided
                    if (searchTerm) {
                        conversations = conversations.filter(conv => 
                            conv.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                            conv.lastMessage.toLowerCase().includes(searchTerm.toLowerCase())
                        );
                    }

                    // Render conversations
                    if (conversations.length === 0) {
                        elements.conversationsContainer.innerHTML = '<div class="no-conversations">No conversations found</div>';
                        return;
                    }

                    elements.conversationsContainer.innerHTML = conversations.map(conv => `
                        <div class="conversation" data-user-id="${conv.id}">
                            <div class="conversation-avatar ${onlineUsers.has(conv.id) ? 'online' : ''}">${conv.name.charAt(0).toUpperCase()}</div>
                            <div class="conversation-details">
                                <div class="conversation-header">
                                    <div class="conversation-name">${escapeHtml(conv.name)}</div>
                                    <div class="conversation-time">${formatTime(conv.lastMessageTime)}</div>
                                </div>
                                <div class="conversation-preview">${escapeHtml(conv.lastMessage)}</div>
                            </div>
                            ${conv.unread ? '<div class="unread-indicator">New</div>' : ''}
                        </div>
                    `).join('');

                    // Add click event to each conversation
                    document.querySelectorAll('.conversation').forEach(conv => {
                        conv.addEventListener('click', () => {
                            const userId = conv.getAttribute('data-user-id');
                            const userName = conv.querySelector('.conversation-name').textContent;
                            loadPrivateMessages(userId, userName);
                        });
                    });

                } else if (activeTab === 'community') {
                    // For community, we just show one conversation for the community chat
                    elements.conversationsContainer.innerHTML = `
                        <div class="conversation" data-conversation-id="community">
                            <div class="conversation-avatar">C</div>
                            <div class="conversation-details">
                                <div class="conversation-header">
                                    <div class="conversation-name">Community Chat</div>
                                    <div class="conversation-time">Now</div>
                                </div>
                                <div class="conversation-preview">Join the community conversation</div>
                            </div>
                        </div>
                    `;

                    // Add click event to community conversation
                    document.querySelector('.conversation').addEventListener('click', () => {
                        loadCommunityChat();
                    });
                }
            } catch (error) {
                console.error('Error loading conversations:', error);
                elements.conversationsContainer.innerHTML = '<div class="error-message">Error loading conversations</div>';
            }
        }

        // --- LOAD PRIVATE MESSAGES ---
        async function loadPrivateMessages(recipientId, recipientName) {
            activeConversation = recipientId;
            elements.chatHeader.style.display = 'flex';
            elements.chatUserName.textContent = recipientName;
            elements.chatUserStatus.textContent = onlineUsers.has(recipientId) ? 'Online' : 'Offline';
            elements.chatUserAvatar.classList.toggle('online', onlineUsers.has(recipientId));
            elements.chatUserAvatar.textContent = recipientName.charAt(0).toUpperCase();
            elements.messageInputContainer.style.display = 'flex';

            if (isMobile()) {
                elements.sidebar.classList.add('hidden');
            }

            elements.messagesContainer.innerHTML = '<div class="loading-spinner"></div>';

            try {
                const { data: messages, error } = await supabase
                    .from('messages')
                    .select('*, profiles!messages_user_id_fkey(full_name)')
                    .or(`and(user_id.eq.${currentUser.id},recipient_id.eq.${recipientId}),and(user_id.eq.${recipientId},recipient_id.eq.${currentUser.id})`)
                    .eq('is_private', true)
                    .order('created_at', { ascending: true });

                if (error) throw error;

                // Mark messages as read if they are from the other user and unread
                const unreadMessageIds = messages
                    .filter(msg => msg.user_id !== currentUser.id && !msg.is_read)
                    .map(msg => msg.id);

                if (unreadMessageIds.length > 0) {
                    await markMessagesAsRead(unreadMessageIds);
                }

                // Render messages
                if (messages.length === 0) {
                    elements.messagesContainer.innerHTML = '<div class="no-messages">No messages yet. Start a conversation!</div>';
                    return;
                }

                elements.messagesContainer.innerHTML = messages.map(msg => `
                    <div class="message ${msg.user_id === currentUser.id ? 'sent' : 'received'}" data-message-id="${msg.id}">
                        <div class="message-header">
                            <span>${msg.user_id === currentUser.id ? 'You' : escapeHtml(msg.profiles?.full_name || 'Unknown')}</span>
                            <span>${formatTime(msg.created_at)}</span>
                        </div>
                        <div class="message-content">${escapeHtml(msg.content)}</div>
                        ${msg.user_id === currentUser.id ? `<button class="delete-btn" data-message-id="${msg.id}">Delete</button>` : ''}
                    </div>
                `).join('');

                // Add event listeners to delete buttons
                document.querySelectorAll('.delete-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const messageId = btn.getAttribute('data-message-id');
                        deleteMessage(messageId);
                    });
                });

                // Scroll to bottom
                elements.messagesContainer.scrollTop = elements.messagesContainer.scrollHeight;

            } catch (error) {
                console.error('Error loading messages:', error);
                elements.messagesContainer.innerHTML = '<div class="error-message">Error loading messages</div>';
            }
        }

        // --- LOAD COMMUNITY CHAT ---
        async function loadCommunityChat() {
            activeConversation = 'community';
            elements.chatHeader.style.display = 'flex';
            elements.chatUserName.textContent = 'Community Chat';
            elements.chatUserStatus.textContent = 'Public';
            elements.chatUserAvatar.textContent = 'C';
            elements.chatUserAvatar.classList.remove('online');
            elements.messageInputContainer.style.display = 'flex';

            if (isMobile()) {
                elements.sidebar.classList.add('hidden');
            }

            elements.messagesContainer.innerHTML = '<div class="loading-spinner"></div>';

            try {
                const { data: messages, error } = await supabase
                    .from('messages')
                    .select('*, profiles!messages_user_id_fkey(full_name)')
                    .eq('is_private', false)
                    .order('created_at', { ascending: true });

                if (error) throw error;

                // Render messages
                if (messages.length === 0) {
                    elements.messagesContainer.innerHTML = '<div class="no-messages">No messages in the community chat yet.</div>';
                    return;
                }

                elements.messagesContainer.innerHTML = messages.map(msg => `
                    <div class="message ${msg.user_id === currentUser.id ? 'sent' : 'received'}" data-message-id="${msg.id}">
                        <div class="message-header">
                            <span>${msg.user_id === currentUser.id ? 'You' : escapeHtml(msg.profiles?.full_name || 'Unknown')}</span>
                            <span>${formatTime(msg.created_at)}</span>
                        </div>
                        <div class="message-content">${escapeHtml(msg.content)}</div>
                        ${msg.user_id === currentUser.id ? `<button class="delete-btn" data-message-id="${msg.id}">Delete</button>` : ''}
                    </div>
                `).join('');

                // Add event listeners to delete buttons
                document.querySelectorAll('.delete-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const messageId = btn.getAttribute('data-message-id');
                        deleteMessage(messageId);
                    });
                });

                // Scroll to bottom
                elements.messagesContainer.scrollTop = elements.messagesContainer.scrollHeight;

            } catch (error) {
                console.error('Error loading community messages:', error);
                elements.messagesContainer.innerHTML = '<div class="error-message">Error loading messages</div>';
            }
        }

        // --- MARK MESSAGES AS READ ---
        async function markMessagesAsRead(messageIds) {
            try {
                const { error } = await supabase
                    .from('messages')
                    .update({ is_read: true })
                    .in('id', messageIds);

                if (error) throw error;
            } catch (error) {
                console.error('Error marking messages as read:', error);
            }
        }

        // --- DELETE MESSAGE ---
        async function deleteMessage(messageId) {
            try {
                const { error } = await supabase
                    .from('messages')
                    .delete()
                    .eq('id', messageId);

                if (error) throw error;

                // Remove the message from the UI
                const messageElement = document.querySelector(`.message[data-message-id="${messageId}"]`);
                if (messageElement) {
                    messageElement.remove();
                }

                showToast('Message deleted');
            } catch (error) {
                console.error('Error deleting message:', error);
                showToast('Error deleting message', 'error');
            }
        }

        elements.messageForm.addEventListener('submit', async e => {
            e.preventDefault();
            const content = elements.messageInput.value.trim();
            if (!content) return showToast('Please enter a message', 'error');

            const user = await checkAuth();
            if (!user) return;

            const messageData = {
                content,
                user_id: user.id,
                is_private: activeConversation !== 'community',
                is_read: false
            };
            if (messageData.is_private) messageData.recipient_id = activeConversation;

            const { error } = await supabase.from('messages').insert([messageData]);
            if (error) return showToast(`Error sending message: ${error.message}`, 'error');

            elements.messageInput.value = '';
            if (activeConversation === 'community') loadCommunityChat();
            else loadPrivateMessages(activeConversation, elements.chatUserName.textContent);
        });

        // --- TAB BUTTONS ---
        elements.tabBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                elements.tabBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                activeTab = btn.getAttribute('data-tab');
                activeConversation = null;
                elements.chatHeader.style.display = 'none';
                elements.messageInputContainer.style.display = 'none';
                elements.messagesContainer.innerHTML = '<div class="no-messages">Select a conversation to start chatting</div>';
                loadConversations();
            });
        });

        // --- BACK TO INBOX ---
        elements.backToInboxBtn.addEventListener('click', () => {
            elements.sidebar.classList.remove('hidden');
            elements.chatHeader.style.display = 'none';
            elements.messageInputContainer.style.display = 'none';
            elements.messagesContainer.innerHTML = '<div class="no-messages">Select a conversation to start chatting</div>';
            activeConversation = null;
        });

        // --- LOGOUT ---
        elements.logoutBtn.addEventListener('click', async () => {
            try {
                showToast('Logging out...', 'warning');
                await supabase.auth.signOut();
                showToast('üëã Logged out successfully');
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 1000);
            } catch (error) {
                console.error('Logout error:', error);
                showToast('Error logging out. Please try again.', 'error');
            }
        });

        // --- SEARCH INPUT ---
        elements.searchInput.addEventListener('input', debounce(() => {
            loadConversations(elements.searchInput.value);
        }, 300));

        // --- INIT APP ---
        async function initApp() {
            currentUser = await checkAuth();
            if (!currentUser) return;

            const channel = supabase.channel('online-users')
                .on('presence', { event: 'sync' }, () => {
                    onlineUsers = new Set(Object.keys(channel.presenceState()));
                    if (activeConversation && activeConversation !== 'community') {
                        elements.chatUserStatus.textContent = onlineUsers.has(activeConversation) ? 'Online' : 'Offline';
                        elements.chatUserAvatar.classList.toggle('online', onlineUsers.has(activeConversation));
                    }
                    if (!activeConversation) loadConversations();
                })
                .subscribe(async status => {
                    if (status === 'SUBSCRIBED') {
                        await channel.track({ user_id: currentUser.id, online_at: new Date().toISOString() });
                    }
                });

            supabase.channel('messages')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'messages' }, () => {
                    if (activeConversation) {
                        if (activeConversation === 'community') loadCommunityChat();
                        else loadPrivateMessages(activeConversation, elements.chatUserName.textContent);
                    } else loadConversations();
                })
                .subscribe();

            // --- Auto-open chat if sessionStorage exists ---
            const sellerId = sessionStorage.getItem('chatSellerId');
            const sellerName = sessionStorage.getItem('chatSellerName');
            const productTitle = sessionStorage.getItem('chatProductTitle');

            if (sellerId && sellerName && productTitle) {
                elements.tabBtns.forEach(btn => btn.classList.remove('active'));
                document.querySelector('.tab-btn[data-tab="inbox"]').classList.add('active');
                activeTab = 'inbox';
                await loadPrivateMessages(sellerId, sellerName);
                elements.messageInput.value = `Hi ${sellerName}, I'm interested in your product: ${productTitle}`;
                sessionStorage.removeItem('chatSellerId');
                sessionStorage.removeItem('chatSellerName');
                sessionStorage.removeItem('chatProductTitle');
            } else loadConversations();
        }

        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>